<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
	<style>
		:root {
			--primary-color: #8ab4f8;
			--primary-dark: #7ba3e6;
			--secondary-color: #81c995;
			--secondary-dark: #72b586;
			--danger-color: #f28b82;
			--danger-dark: #e37b72;
			--bg-dark: #121212;
			--bg-darker: #0a0a0a;
			--bg-card: #1e1e1e;
			--text-primary: #e1e1e1;
			--text-secondary: #b0b0b0;
			--border-color: #333333;
			--border-radius: 8px;
			--box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
		}

		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		body {
			background-color: var(--bg-dark);
			display: flex;
			align-items: center;
			justify-content: center;
			min-height: 100vh;
			padding: 20px;
			color: var(--text-primary);
			font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
		}

		.chat-container {
			width: 100%;
			max-width: 500px;
			display: flex;
			flex-direction: column;
			gap: 15px;
			background-color: var(--bg-card);
			border-radius: 16px;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
			padding: 20px;
			border: 1px solid var(--border-color);
		}

		.chat-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 10px;
		}

		.chat-title {
			font-size: 1.2rem;
			font-weight: 500;
			color: var(--primary-color);
		}

		.tab-bar {
			display: flex;
			border-bottom: 1px solid var(--border-color);
			margin-bottom: 10px;
		}

		.tab {
			flex: 1;
			padding: 10px;
			text-align: center;
			background: var(--bg-darker);
			cursor: pointer;
			transition: background 0.3s;
		}

		.tab.active {
			background: var(--primary-color);
			color: #202124;
		}

		.toolbar {
			display: flex;
			flex-direction: column;
			gap: 15px;
		}

		.controls-group {
			display: flex;
			gap: 8px;
			align-items: center;
			flex-wrap: nowrap;
			overflow-x: auto;
		}

		.icon-button {
			width: 40px;
			height: 40px;
			padding: 0;
			display: flex;
			align-items: center;
			justify-content: center;
			flex-shrink: 0;
			border-radius: 50%;
			border: none;
			cursor: pointer;
			transition: all 0.3s ease;
			font-size: 16px;
		}

		.button-group-horizontal {
			display: flex;
			gap: 10px;
			align-items: center;
		}
		
		.vertical-group {
			display: flex;
			flex-direction: column;
			gap: 12px;
			width: 100%;
		}

		.btn-primary {
			background-color: var(--primary-color);
			color: #202124;
		}

		.btn-primary:hover {
			background-color: var(--primary-dark);
		}

		.btn-secondary {
			background-color: var(--secondary-color);
			color: #202124;
		}

		.btn-secondary:hover {
			background-color: var(--secondary-dark);
		}

		.btn-danger {
			background-color: var(--danger-color);
			color: #202124;
		}

		.btn-danger:hover {
			background-color: var(--danger-dark);
		}

		button:disabled {
			background-color: var(--border-color);
			cursor: not-allowed;
			opacity: 0.5;
			color: var(--text-secondary);
		}

		.text-area {
			width: 100%;
			padding: 15px;
			font-size: 16px;
			border: 1px solid var(--border-color);
			border-radius: var(--border-radius);
			min-height: 150px;
			resize: vertical;
			font-family: inherit;
			background-color: var(--bg-darker);
			color: var(--text-primary);
		}

		.text-area:focus {
			outline: none;
			border-color: var(--primary-color);
			box-shadow: 0 0 0 2px rgba(138, 180, 248, 0.2);
		}

		.text-area::placeholder {
			color: var(--text-secondary);
		}

		.result-box {
			padding: 15px;
			border: 1px solid var(--border-color);
			border-radius: var(--border-radius);
			background-color: var(--bg-darker);
			font-size: 16px;
			line-height: 1.6;
			color: var(--text-primary);
			min-height: 2em; 
			max-height: 4em;             
			transition: none;
		}

		.translation-box {
			padding: 15px;
			border: 1px solid var(--border-color);
			border-radius: var(--border-radius);
			background-color: var(--bg-darker);
			font-size: 16px;
			line-height: 1.6;
			min-height: 6em;
			color: var(--text-primary);
			display: block !important;
		}

		.status {
			display: flex;
			align-items: center;
			gap: 10px;
			font-size: 14px;
			border: 1px solid var(--border-color);
			background-color: var(--bg-darker);
			padding: 12px 15px;
			border-radius: var(--border-radius);
			color: var(--text-primary);
			white-space: nowrap;
		}

		.suggestions {
			margin-top: 15px;
			width: 100%;
			background-color: var(--bg-darker);
			border-radius: var(--border-radius);
			padding: 15px;
			border: 1px solid var(--border-color);
			color: var(--text-primary);
		}

		.suggestions-title {
			display: flex;
			align-items: center;
			gap: 8px;
			margin-bottom: 10px;
			color: var(--primary-color);
		}

		.suggestions ul {
			padding-left: 20px;
			margin-top: 8px;
		}

		.suggestions li {
			margin-bottom: 8px;
			line-height: 1.5;
			color: var(--text-secondary);
			cursor: pointer;
		}

		.suggestions li:hover {
			color: var(--primary-color);
		}

		.hidden {
			display: none !important;
		}

		/* Pulse animation for recording state */
		@keyframes pulse {
			0% { box-shadow: 0 0 0 0 rgba(242, 139, 130, 0.7); }
			70% { box-shadow: 0 0 0 10px rgba(242, 139, 130, 0); }
			100% { box-shadow: 0 0 0 0 rgba(242, 139, 130, 0); }
		}

		.btn-danger {
			animation: pulse 1.5s infinite;
		}

		/* Mobile styles */
		@media (max-width: 600px) {
			.chat-container {
				border-radius: 0;
				max-width: 100vw;
				height: 100vh;
				padding: 15px;
			}

			.toolbar {
				gap: 10px;
			}

			.text-area {
				min-height: 120px;
				font-size: 16px;
			}
			
			.icon-button {
				flex: none;
			}
			
			.suggestions {
				padding: 12px;
			}
		}
	</style>	
<head>
<body>
	<div class="chat-container">
		<div class="chat-header">
			<div class="chat-title">
				<i class="fas fa-comments"></i> Trò chuyện với người nước ngoài
			</div>
		</div>

		<div class="tab-bar">
			<div class="tab active" data-lang="vi-VN">Tiếng Việt</div>
			<div class="tab" data-lang="ja-JP">Tiếng Nhật</div>
			<div class="tab" data-lang="en-US">English</div>
		</div>

		<div class="toolbar">
			<div class="vertical-group">
				<div class="button-group-horizontal">
					<button id="micBtn" class="icon-button btn-primary" title="Bắt đầu ghi âm">
						<i class="fas fa-microphone"></i>
					</button>
					<button id="suggestBtn" class="icon-button btn-primary" title="Gợi ý cách nói" disabled>
						<i class="fas fa-lightbulb"></i>
					</button>
					<button id="speakBtn" class="icon-button btn-primary" title="Phát âm thanh" disabled>
						<i class="fas fa-volume-up"></i>
					</button>
					<button id="clearBtn" class="icon-button btn-danger" title="Xóa tất cả">
						<i class="fas fa-trash"></i>
					</button>                    
				</div>

				<div class="status" id="status">
					<span id="status-icon"><i class="fas fa-info-circle"></i></span>
					<span id="status-message">Nhấn nút microphone và nói...</span>
					<div id="speech-indicator" class="speech-progress hidden">
						<div class="bar"></div>
						<div class="bar"></div>
						<div class="bar"></div>
						<div class="bar"></div>
						<div class="bar"></div>
					</div>                
				</div>    

				<div id="result" class="text-area result-box" style="white-space: pre-wrap; min-height: 100px;"></div>
				
				<div id="translation" class="translation-box">
					<div class="message" id="translation-text"></div>
				</div>
				
				<textarea id="editableText" class="text-area" placeholder="Editable..."></textarea>
			</div>

			<!-- Phần gợi ý đã được di chuyển ra ngoài vertical-group -->
			<div id="corrections" class="suggestions hidden">
				<div class="suggestions-title">
					<i class="fas fa-lightbulb"></i>
					<span id="suggestions-title-text">Có phải bạn muốn nói là:</span>
				</div>
				<div id="suggestions"></div>
				
				<!-- Nút dịch gợi ý -->
				<div class="button-group-horizontal">
					<button id="translateSuggestionBtn" class="icon-button btn-secondary" title="Gợi ý dịch" disabled>
						<i class="fas fa-language"></i> 
					</button>
					
					<button id="vocabBtn" class="icon-button btn-secondary" title="Gợi ý từ vựng" disabled>
					  <i class="fas fa-book"></i>
					</button>
				</div>
				
				<!-- Kết quả dịch gợi ý -->
				<div id="suggestionTranslation" class="translation-box hidden" style="margin-top: 10px;"></div>
				
				<div id="vocabBox" class="suggestions hidden" style="margin-top: 10px;">
					<div class="suggestions-title">
						<i class="fas fa-book-open"></i>
						<span>Gợi ý từ vựng liên quan:</span>
					</div>
					<div id="vocabList"></div>
				</div>            
			</div>
		</div>
	</div>

    <script>        
            // DOM elements
            const elements = {
				micBtn: document.getElementById('micBtn'),
				suggestBtn: document.getElementById('suggestBtn'),
				speakBtn: document.getElementById('speakBtn'),
				clearBtn: document.getElementById('clearBtn'),
				tabs: document.querySelectorAll('.tab'),
				translationText: document.getElementById('translation-text'),
				editableText: document.getElementById('editableText'),
				status: document.getElementById('status'),
				suggestions: document.getElementById('suggestions'),
				suggestionsTitle: document.getElementById('suggestions-title-text'),
				resultBox: document.getElementById('result'),
				translationBox: document.getElementById('translation'),
				correctionsBox: document.getElementById('corrections'),
				translateSuggestionBtn: document.getElementById('translateSuggestionBtn'),
				suggestionTranslation: document.getElementById('suggestionTranslation'),
				vocabBtn: document.getElementById('vocabBtn'),
				vocabBox: document.getElementById('vocabBox'),
				vocabList: document.getElementById('vocabList'),
				messageText: document.getElementById('result')
            };

            const GEMINI_API_KEY = "AIzaSyDaROReiR48rjfavf8Lk6XvphC6QxKPZo4";
			// Initialize currentLang with default language
			let currentLang = 'vi-VN';
			
			// Speech Recognition Logic
			let recognition = null;
			let isRecording = false;
			let recognitionTimeout = null;
			let translationDebounceTimer = null;
			let finalTranscript = '';
			let interimTranscript = '';
			let recognitionPaused = false;
			let lastRecognitionResult = '';
			let consecutiveSilenceCount = 0;
			let recognitionStoppedManually = false;

			// Initialize Web Speech API
			function initSpeechRecognition() {
				// Check browser support
				if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
					showStatus('error', 'Trình duyệt không hỗ trợ nhận diện giọng nói. Hãy dùng Chrome hoặc Edge.');
					elements.micBtn.disabled = true;
					return false;
				}

				try {
					// Create recognition instance
					recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
					
					// Configure settings
					recognition.lang = currentLang;
					recognition.interimResults = true;
					recognition.continuous = true;
					recognition.maxAlternatives = 3;

					// Handle recognition results
					recognition.onresult = handleRecognitionResult;
					
					// Handle events
					recognition.onstart = handleRecognitionStart;
					recognition.onend = handleRecognitionEnd;
					recognition.onerror = handleRecognitionError;
					recognition.onnomatch = () => {
						showStatus('warning', 'Không nhận diện được. Vui lòng thử lại.');
					};
					
					return true;
				} catch (error) {
					console.error("Error initializing speech recognition:", error);
					showStatus('error', `Lỗi khởi tạo: ${error.message}`);
					return false;
				}
			}

			// Handle speech recognition results
			function handleRecognitionResult(event) {
				consecutiveSilenceCount = 0;

				let interimResult = '';
				let finalResult = '';

				for (let i = event.resultIndex; i < event.results.length; i++) {
					const transcript = event.results[i][0].transcript.trim();
					if (event.results[i].isFinal) {
						finalResult += transcript + ' ';
						interimTranscript = interimTranscript.replace(transcript, '').trim();
					} else {
						interimResult += transcript + ' ';
					}
				}

				if (finalResult) {
					finalTranscript += finalResult;
					lastRecognitionResult = finalResult;
					const trimmed = finalTranscript.trim();
					elements.editableText.value = trimmed;
					scheduleTranslation(trimmed);
					toggleActionButtons(true);
				}

				if (interimResult) {
					interimTranscript = interimResult;
					elements.resultBox.textContent = interimTranscript;
					elements.resultBox.classList.remove('hidden');
				}
			}

			// Start speech recognition with error handling
			function startRecognition() {
				try {
					if (!recognition) {
						if (!initSpeechRecognition()) return;
					}
					
					// Configure for current language
					recognition.lang = currentLang;
					
					// Start recording
					recognition.start();
					isRecording = true;
					recognitionPaused = false;
					
					// Update UI
					updateMicButtonState(true);
					showStatus('recording', 'Đang nghe... ');
					
				} catch (error) {
					console.error("Error starting recognition:", error);
					showStatus('error', `Không thể bắt đầu ghi âm: ${error.message}`);
					updateMicButtonState(false);
				}
			}

			// Stop speech recognition with error handling
			function stopRecognition() {
				try {
					recognitionStoppedManually = true;
					if (recognition) {
						recognition.stop();
					}
					
					// Clear silence detection
					if (recognitionTimeout) {
						clearTimeout(recognitionTimeout);
						recognitionTimeout = null;
					}
					
					// Update state
					isRecording = false;
					recognitionPaused = false;
					
					// Update UI
					updateMicButtonState(false);
					showStatus('ready', 'Đã dừng ghi âm');
				} catch (error) {
					console.error("Error stopping recognition:", error);
					showStatus('error', `Lỗi khi dừng ghi âm: ${error.message}`);
				}
			}

			// Handle recognition start event
			function handleRecognitionStart() {
				isRecording = true;
				updateMicButtonState(true);
				
				// Add visual indicator for recording
				const speechProgressIndicator = document.createElement('div');
				speechProgressIndicator.className = 'speech-progress';
				speechProgressIndicator.innerHTML = `
					<div class="bar"></div>
					<div class="bar"></div>
					<div class="bar"></div>
					<div class="bar"></div>
					<div class="bar"></div>
				`;
				elements.status.appendChild(speechProgressIndicator);
			}

			// Handle recognition end event
			function handleRecognitionEnd() {
				isRecording = false;
				updateMicButtonState(false);
				
				// Process any pending interim results if we have them
				if (interimTranscript.trim()) {
					finalTranscript += interimTranscript.trim() + ' ';
					elements.editableText.value = finalTranscript.trim();
					scheduleTranslation(finalTranscript.trim());
					
					// Clear interim display
					interimTranscript = '';
					elements.resultBox.classList.add('hidden');
				}
				
				// Enable buttons if we have text
				toggleActionButtons(!!elements.editableText.value.trim());
				
				// Tự động khởi động lại nếu không phải dừng thủ công
				if (!recognitionStoppedManually) {
					try {
						recognition.start();
						isRecording = true;
						updateMicButtonState(true);
						showStatus('recording', 'Đang nghe... Nói điều gì đó');
					} catch (e) {
						console.error("Failed to restart recognition:", e);
						isRecording = false;
						updateMicButtonState(false);
						showStatus('error', 'Không thể tiếp tục ghi âm');
					}
				} else {
					recognitionStoppedManually = false; // Reset lại sau khi đã dừng thủ công
				}				
			}

			// Handle recognition errors
			function handleRecognitionError(event) {
				console.error("Recognition error:", event.error);
				
				const errorMessages = {
					'no-speech': 'Không phát hiện giọng nói.',
					'audio-capture': 'Không thể truy cập microphone',
					'not-allowed': 'Vui lòng cho phép truy cập microphone',
					'network': 'Lỗi kết nối mạng',
					'aborted': 'Nhận diện bị hủy',
					'language-not-supported': 'Ngôn ngữ không được hỗ trợ',
					'service-not-allowed': 'Dịch vụ nhận diện không có sẵn',
					'bad-grammar': 'Lỗi ngữ pháp nhận diện',
					default: `Lỗi nhận diện: ${event.error}`
				};
				
				const errorMessage = errorMessages[event.error] || errorMessages.default;
				showStatus('error', errorMessage);
				
				// Fatal errors that should stop recognition
				if (['not-allowed', 'audio-capture', 'network', 'language-not-supported', 'service-not-allowed'].includes(event.error)) {
					isRecording = false;
					recognitionPaused = false;
					updateMicButtonState(false);
					showStatus('error', errorMessage);
				} else {
					// Non-fatal errors, show warning but continue if still recording
					showStatus('warning', errorMessage);
					
					// Nếu đang ghi âm và chưa tạm dừng, thử restart lại
					if (isRecording && !recognitionPaused) {
						setTimeout(() => {
							try {
								recognition.stop(); // tránh lỗi "already started"
								recognition.start();
							} catch (e) {
								console.error("Failed to restart after error:", e);
								showStatus('error', 'Không thể tiếp tục ghi âm');								
							}
						}, 1000);
					}
				}
			}

			// Update the mic button appearance based on recording state
			function updateMicButtonState(recording) {
				if (recording) {
					elements.micBtn.innerHTML = '<i class="fas fa-stop"></i>';
					elements.micBtn.title = 'Dừng ghi âm';
					elements.micBtn.classList.replace('btn-primary', 'btn-danger');
				} else {
					elements.micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
					elements.micBtn.title = 'Bắt đầu ghi âm';
					elements.micBtn.classList.replace('btn-danger', 'btn-primary');
				}
			}

			// Show status message with appropriate icon
			function showStatus(type, message) {
				const icons = {
					'info': 'fa-info-circle',
					'success': 'fa-check-circle',
					'warning': 'fa-exclamation-circle',
					'error': 'fa-exclamation-triangle',
					'recording': 'fa-microphone',
					'processing': 'fa-cog fa-spin',
					'ready': 'fa-info-circle'
				};
				
				// Cập nhật biểu tượng và dòng chữ
				document.getElementById('status-icon').innerHTML = `<i class="fas ${icons[type] || icons.info}"></i>`;
				document.getElementById('status-message').textContent = message;

				// Hiển thị sound wave nếu đang ghi âm
				const wave = document.getElementById('speech-indicator');
				if (type === 'recording') {
					wave.classList.remove('hidden');
				} else {
					wave.classList.add('hidden');
				}
			}

			// Toggle recognition on/off
			function toggleRecognition() {
				if (isRecording) {
					stopRecognition();
				} else {
					// Clear buffers if starting fresh
					if (!elements.editableText.value.trim()) {
						finalTranscript = '';
						interimTranscript = '';
					} else {
						// If continuing with existing text, initialize final transcript
						finalTranscript = elements.editableText.value.trim() + ' ';
					}
					
					startRecognition();
				}
			}

			// Schedule translation with debounce
			function scheduleTranslation(text) {
				// Clear any pending translation
				if (translationDebounceTimer) {
					clearTimeout(translationDebounceTimer);
				}
				
				// Schedule new translation with delay
				translationDebounceTimer = setTimeout(() => {
					displayTranslation(text);
				}, 800); // 800ms debounce
			}

			// Reset recognition for new session
			function resetRecognition() {
				// Stop any active recognition
				if (isRecording) {
					stopRecognition();
				}
				
				// Clear all timers
				if (recognitionTimeout) {
					clearTimeout(recognitionTimeout);
					recognitionTimeout = null;
				}
				
				if (translationDebounceTimer) {
					clearTimeout(translationDebounceTimer);
					translationDebounceTimer = null;
				}
				
				// Clear transcripts
				finalTranscript = '';
				interimTranscript = '';
				consecutiveSilenceCount = 0;
				
				// Reset UI elements
				elements.messageText.textContent = '';
				elements.editableText.value = '';
				elements.resultBox.classList.add('hidden');
			}

			// Change recognition language
			function changeRecognitionLanguage(newLang) {
				currentLang = newLang;
				
				// Update recognition instance if it exists
				if (recognition) {
					const wasRecording = isRecording;
					
					// Stop current recognition
					if (wasRecording) {
						stopRecognition();
					}
					
					// Update language
					recognition.lang = currentLang;
					
					// Restart if it was active
					if (wasRecording) {
						// Short delay to ensure clean restart
						setTimeout(() => {
							startRecognition();
						}, 300);
					}
				}
			}

			// Event listener for mic button
			elements.micBtn.addEventListener('click', () => {
				if (!recognition) {
					initSpeechRecognition();
					
					// Đánh dấu là user đã từng cấp quyền
					localStorage.setItem('micPermissionAsked', 'true');
				}
				toggleRecognition();
			});
			
			// Thêm sự kiện cho nút gợi ý
			elements.suggestBtn.addEventListener('click', async () => {
				const text = elements.editableText.value.trim();
				if (!text) return;

				try {
					showStatus('processing', 'Đang tạo gợi ý...');
					const suggestion = await suggestCorrectionWithGemini(text, currentLang);

					elements.suggestions.innerHTML = `<ul><li id="suggestion-item">${suggestion}</li></ul>`;
					elements.correctionsBox.classList.remove('hidden');
					elements.translateSuggestionBtn.disabled = false;
					elements.suggestionTranslation.classList.add('hidden');

					showStatus('success', 'Đã tạo gợi ý');
				} catch (error) {
					console.error('Lỗi khi tạo gợi ý:', error);
					showStatus('error', 'Không thể tạo gợi ý.');
				}
			});
						
			// Nút dịch gợi ý
			elements.translateSuggestionBtn.addEventListener('click', async () => {
				const suggestionText = document.getElementById('suggestion-item')?.innerText.trim();
				if (!suggestionText) {
					showStatus('error', 'Không có gợi ý để dịch.');
					return;
				}

				showStatus('processing', 'Đang dịch gợi ý...');

				try {
					const translatedText = await translateWithGemini(suggestionText, currentLang, 'vi-VN');
					elements.suggestionTranslation.innerText = translatedText;
					elements.suggestionTranslation.classList.remove('hidden');
					showStatus('success', 'Đã dịch gợi ý');
				} catch (error) {
					console.error('Lỗi dịch gợi ý:', error);
					elements.suggestionTranslation.innerText = `Lỗi: ${error.message}`;
					elements.suggestionTranslation.classList.remove('hidden');
					showStatus('error', 'Không thể dịch gợi ý.');
				}
			});
			
			// Nút gợi ý từ vựng
			elements.vocabBtn.addEventListener('click', async () => {
				const text = elements.editableText.value.trim();
				if (!text) return;

				showStatus('processing', 'Đang lấy từ vựng...');

				try {
					const vocabHTML = await suggestVocabularyWithGemini(text, currentLang, 'tab');
					elements.vocabList.innerHTML = vocabHTML;
					elements.vocabBox.classList.remove('hidden');
					showStatus('success', 'Đã gợi ý từ vựng');
				} catch (error) {
					console.error('Lỗi từ vựng:', error);
					showStatus('error', 'Không thể lấy từ vựng');
				} finally {
				}
			});


			// Event listener for tab switching (language change)
			elements.tabs.forEach(tab => {
				tab.addEventListener('click', () => {
					// Update UI
					elements.tabs.forEach(t => t.classList.remove('active'));
					tab.classList.add('active');
					
					// Get new language
					const newLang = tab.dataset.lang;
					
					// Update placeholders and UI text
					updateUILanguage(newLang);
					
					// Change recognition language
					changeRecognitionLanguage(newLang);
					
					// Show status
					const langNames = {
						'vi-VN': 'Tiếng Việt',
						'ja-JP': 'Tiếng Nhật',
						'en-US': 'Tiếng Anh'
					};
					showStatus('info', `Đã chuyển sang ${langNames[newLang] || newLang}`);
					
					// Retranslate current text if exists
					if (elements.editableText.value.trim()) {
						displayTranslation(elements.editableText.value.trim());
					}
				});
			});

			// Handle user typing directly into textarea
			elements.editableText.addEventListener('input', () => {
				finalTranscript = elements.editableText.value.trim();
				toggleActionButtons(!!finalTranscript);
				scheduleTranslation(finalTranscript); // Kích hoạt dịch tự động
			});

			// Add support for keyboard shortcuts
			document.addEventListener('keydown', (event) => {
				// Space key to toggle recording (only when no input fields are focused)
				if (event.code === 'Space' && document.activeElement !== elements.editableText) {
					event.preventDefault();
					toggleRecognition();
				}
			});

			// Init on page load
			function initializeSpeechRecognition() {
				// Initialize speech recognition
				initSpeechRecognition();
				
				// Set initial status
				showStatus('ready', 'Hãy nhấn mic để bắt đầu ghi âm...');
			}

			// Update UI text based on selected language
			function updateUILanguage(lang) {
				// Update textarea placeholder
				elements.editableText.placeholder = {
					'vi-VN': 'Tin nhắn của bạn sẽ xuất hiện ở đây...',
					'ja-JP': 'メッセージはここに表示されます...',
					'en-US': 'Your message will appear here...'
				}[lang] || 'Nhập tin nhắn...';
				
				// Update other UI elements as needed
				elements.suggestionsTitle.textContent = {
					'vi-VN': 'Có phải bạn muốn nói là:',
					'ja-JP': 'もしかして言いたかったのは：',
					'en-US': 'Did you mean:'
				}[lang] || 'Gợi ý:';
			}

			// Call initialization when page loads
			document.addEventListener('DOMContentLoaded', initializeSpeechRecognition);

			// Hàm xác định ngôn ngữ đích dựa trên ngôn ngữ nguồn
			function getTargetLanguage(sourceLang) {
				switch(sourceLang) {
					case 'vi-VN':
						return 'en-US'; // Tiếng Việt -> Tiếng Anh
					case 'en-US':
						return 'vi-VN'; // Tiếng Anh -> Tiếng Việt
					case 'ja-JP':
						return 'vi-VN'; // Tiếng Nhật -> Tiếng Việt
					default:
						return 'en-US'; // Mặc định là tiếng Anh
				}
			}

			// Hàm dịch sử dụng API Gemini
			async function translateWithGemini(text, sourceLang, targetLang) {
				// Ánh xạ mã ngôn ngữ Web Speech API sang mã ngôn ngữ cho API Gemini
				const languageMap = {
					'vi-VN': 'Vietnamese',
					'en-US': 'English',
					'ja-JP': 'Japanese'
				};
				
				// Chuyển đổi mã ngôn ngữ
				const sourceLanguage = languageMap[sourceLang] || 'Vietnamese';
				const targetLanguage = languageMap[targetLang] || 'English';
				
				// Tạo prompt cho Gemini
				const prompt = `Translate the following text from ${sourceLanguage} to ${targetLanguage}. 
			Only respond with the translated text, nothing else:

			${text}`;
				
				try {
					// Cấu hình request
					const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent';
					const response = await fetch(`${apiUrl}?key=${GEMINI_API_KEY}`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							contents: [{
								parts: [{
									text: prompt
								}]
							}],
							generationConfig: {
								temperature: 0.2,
								topK: 40,
								topP: 0.95,
								maxOutputTokens: 1024,
							}
						})
					});
					
					// Xử lý phản hồi
					if (!response.ok) {
						const errorData = await response.json();
						throw new Error(`API error: ${errorData.error?.message || response.statusText}`);
					}
					
					const data = await response.json();
					
					// Kiểm tra và trích xuất văn bản dịch
					if (data.candidates && data.candidates[0]?.content?.parts && data.candidates[0].content.parts[0]?.text) {
						return data.candidates[0].content.parts[0].text.trim();
					} else {
						throw new Error('Không nhận được bản dịch từ API');
					}
				} catch (error) {
					console.error('Lỗi khi gọi API Gemini:', error);
					throw new Error(`Không thể dịch: ${error.message}`);
				}
			}

			// Hàm bật/tắt các nút hành động dựa trên trạng thái có văn bản
			function toggleActionButtons(hasText) {
				// Chỉ bật các nút khi có văn bản
				elements.speakBtn.disabled = !hasText;
				elements.suggestBtn.disabled = !hasText;
				elements.vocabBtn.disabled = !hasText; 
				
				// Cập nhật giao diện nếu không có văn bản
				if (!hasText) {
					elements.translationBox.classList.add('hidden');
					elements.correctionsBox.classList.add('hidden');
				}
			}

			// Thêm chức năng phát âm cho nút speakBtn
			elements.speakBtn.addEventListener('click', () => {
				// Xác định văn bản cần phát âm
				const textToSpeak = elements.translationText.textContent.trim();
				if (!textToSpeak) return;
				
				// Xác định ngôn ngữ cho phát âm
				const speakLanguage = getTargetLanguage(currentLang);
				
				// Sử dụng Web Speech API để phát âm
				const utterance = new SpeechSynthesisUtterance(textToSpeak);
				utterance.lang = speakLanguage;
				speechSynthesis.speak(utterance);
				
				// Hiển thị trạng thái
				showStatus('info', 'Đang phát âm...');
			});

			// Thêm chức năng nút clear
			elements.clearBtn.addEventListener('click', function() {
				try {
					// Dừng ghi âm nếu đang chạy
					if (isRecording) {
						stopRecognition();
					}
					
					// Xóa nội dung các phần tử
					elements.editableText.value = '';
					elements.translationText.textContent = '';
					elements.resultBox.textContent = '';
					elements.suggestions.innerHTML = '';
					elements.suggestionTranslation.textContent = '';
					elements.suggestionTranslation.classList.add('hidden');
					elements.vocabList.innerHTML = '';
					
					// Ẩn các khối không cần thiết
					elements.translationBox.classList.add('hidden');
					elements.correctionsBox.classList.add('hidden');
					elements.vocabBox.classList.add('hidden');
					
					// Reset các biến trạng thái
					finalTranscript = '';
					interimTranscript = '';
					lastTranslatedText = '';
					lastRecognitionResult = '';
					translationQueue = [];
					
					// Vô hiệu hóa các nút hành động
					toggleActionButtons(false);
					
					// Hiển thị trạng thái
					showStatus('info', 'Đã xóa tất cả nội dung');
				} catch (error) {
					console.error("Lỗi khi xóa:", error);
					showStatus('error', 'Lỗi khi xóa nội dung');
				}
			});

			// Biến cờ và trạng thái
			let isTranslating = false;
			let translationQueue = [];
			let lastTranslatedText = '';

			// Hàm hiển thị và xử lý dịch văn bản
			async function displayTranslation(text) {
				// Kiểm tra nếu không có văn bản để dịch
				if (!text || text.trim() === '') {
					elements.translationText.textContent = '';
					elements.translationBox.classList.add('hidden');
					return;
				}

				// Nếu văn bản giống với lần cuối đã dịch, không cần dịch lại
				if (text === lastTranslatedText) {
					return;
				}
				
				// Nếu đang có một quá trình dịch, thêm vào hàng đợi
				if (isTranslating) {
					translationQueue = [text]; // Chỉ giữ yêu cầu mới nhất
					return;
				}
				
				// Đánh dấu đang dịch
				isTranslating = true;
				showStatus('processing', 'Đang dịch...');
				
				try {
					// Xác định ngôn ngữ đích dựa trên ngôn ngữ nguồn hiện tại
					const targetLanguage = getTargetLanguage(currentLang);
					
					// Gọi API Gemini để dịch
					const translatedText = await translateWithGemini(text, currentLang, targetLanguage);
					
					// Lưu văn bản đã dịch để tránh dịch lại
					lastTranslatedText = text;
					
					// Hiển thị kết quả dịch
					elements.translationText.textContent = translatedText;
					elements.translationBox.classList.remove('hidden');
					
					// Cập nhật trạng thái
					showStatus(isRecording ? 'recording' : 'success', isRecording ? 'Đang nghe...' : 'Đã dịch xong');
					
				} catch (error) {
					console.error("Lỗi dịch:", error);
					elements.translationText.textContent = `Không thể dịch: ${error.message}`;
					showStatus('error', 'Lỗi dịch. Vui lòng thử lại.');
				} finally {
					// Đánh dấu đã hoàn thành dịch
					isTranslating = false;
					
					// Kiểm tra hàng đợi
					if (translationQueue.length > 0) {
						const nextText = translationQueue.pop();
						translationQueue = [];
						setTimeout(() => displayTranslation(nextText), 300);
					}
				}
			}

			// Giảm độ nhạy của lịch trình dịch để tránh xung đột với nhận dạng
			function scheduleTranslation(text) {
				if (translationDebounceTimer) {
					clearTimeout(translationDebounceTimer);
				}
				
				const delay = isRecording ? 1500 : 800;
				translationDebounceTimer = setTimeout(() => {
					displayTranslation(text); // Gọi hàm dịch
				}, delay);
			}	

			async function suggestCorrectionWithGemini(text, lang) {
				const languageMap = {
					'vi-VN': 'Vietnamese',
					'en-US': 'English',
					'ja-JP': 'Japanese'
				};
				const language = languageMap[lang] || 'English';

				const prompt = `Please suggest a more grammatically correct or natural way to say the following sentence in ${language}, without changing its meaning. Reply with only the corrected sentence:\n\n"${text}"`;

				const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						contents: [{ parts: [{ text: prompt }] }],
						generationConfig: {
							temperature: 0.3,
							topK: 40,
							topP: 0.95,
							maxOutputTokens: 1024,
						}
					})
				});

				const data = await response.json();
				if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) {
					return data.candidates[0].content.parts[0].text.trim();
				} else {
					throw new Error('Không nhận được phản hồi gợi ý từ API');
				}
			}
			
			async function suggestVocabularyWithGemini(text, lang, format = 'tab') {
				// Xác định ngôn ngữ
				const languageMap = {
					'vi-VN': 'Vietnamese',
					'en-US': 'English',
					'ja-JP': 'Japanese'
				};
				const language = languageMap[lang] || 'English';

				// Tạo prompt phù hợp với ngôn ngữ
				let prompt;
				if (lang === 'ja-JP') {
					prompt = `Extract Japanese vocabulary from this sentence in format: Kanji - Hiragana - Vietnamese meaning. If no vocabulary found, reply "No vocabulary". Only list vocabulary, no explanations:\n\n"${text}"`;
				} else {
					prompt = `Extract important vocabulary words from this ${language} sentence with Vietnamese translations. Format each as: Word - Translation. If none, reply "No vocabulary". Only list words:\n\n"${text}"`;
				}

				const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						contents: [{ parts: [{ text: prompt }] }],
						generationConfig: {
							temperature: 0.3,
							topK: 40,
							topP: 0.95,
							maxOutputTokens: 512,
						}
					})
				});

				const data = await response.json();
				if (!data.candidates || !data.candidates[0]?.content?.parts[0]?.text) {
					throw new Error('Không nhận được từ vựng từ API');
				}

				const rawText = data.candidates[0].content.parts[0].text.trim();

				if (rawText.toLowerCase().includes('no vocabulary')) {
					return '<i>Không có từ vựng nào được phát hiện.</i>';
				}

				// Xử lý định dạng tab
				if (format === 'tab') {
					const rows = rawText.split('\n')
						.filter(line => line.trim() && line.includes('-'))
						.map(line => line.split('-').map(s => s.trim()).join('\t'));
					return `<pre>${rows.join('\n')}</pre>`;
				} else {
					// Xử lý định dạng table
					const rows = rawText.split('\n')
						.filter(line => line.trim() && line.includes('-'))
						.map(line => {
							const [word, translation] = line.split('-').map(s => s.trim());
							return `<tr><td>${word}</td><td>${translation}</td></tr>`;
						});
					
					return `
						<table border="1" cellpadding="5" style="border-collapse: collapse; width: 100%;">
							<tr style="background-color: #222;">
								<th>Từ vựng</th><th>Nghĩa</th>
							</tr>
							${rows.join('\n')}
						</table>
					`;
				}
			}	
    </script>
</body>
</html>
