<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #8ab4f8;
            --primary-dark: #7ba3e6;
            --secondary-color: #81c995;
            --secondary-dark: #72b586;
            --danger-color: #f28b82;
            --danger-dark: #e37b72;
            --bg-dark: #121212;
            --bg-darker: #0a0a0a;
            --bg-card: #1e1e1e;
            --text-primary: #e1e1e1;
            --text-secondary: #b0b0b0;
            --border-color: #333333;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        .chat-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .chat-title {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--primary-color);
        }

        .tab-bar {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: var(--bg-darker);
            cursor: pointer;
            transition: background 0.3s;
        }

        .tab.active {
            background: var(--primary-color);
            color: #202124;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .controls-group {
            display: flex;
            gap: 8px;
            align-items: center;
			flex-wrap: nowrap;
			overflow-x: auto;
        }

        .icon-button {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: var(--bg-darker);
            color: var(--text-primary);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: #202124;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: #202124;
        }

        .btn-secondary:hover {
            background-color: var(--secondary-dark);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: #202124;
        }

        .btn-danger:hover {
            background-color: var(--danger-dark);
        }

        button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
            opacity: 0.5;
            color: var(--text-secondary);
        }

        .text-area {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
            background-color: var(--bg-darker);
            color: var(--text-primary);
        }

        .text-area:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(138, 180, 248, 0.2);
        }

        .text-area::placeholder {
            color: var(--text-secondary);
        }

        .result-box {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-darker);
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .translation-box {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-darker);
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .status {
            padding: 12px 15px;
            background-color: var(--bg-darker);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .status i {
            color: var(--primary-color);
        }

        .loading {
            padding: 15px;
            background-color: var(--bg-darker);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: 1px solid var(--border-color);
        }

        .loading.hidden {
            display: none;
        }

        .loading span {
            color: var(--text-primary);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .suggestions {
            margin-top: 10px;
            color: var(--text-primary);
        }

        .suggestions-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .suggestions ul {
            padding-left: 20px;
            margin-top: 8px;
        }

        .suggestions li {
            margin-bottom: 8px;
            line-height: 1.5;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .suggestions li:hover {
            color: var(--primary-color);
        }

        .hidden {
            display: none !important;
        }

        /* History dialog styles */
        .history-dialog {
            display: flex;
            flex-direction: column;
            color: var(--text-primary);
        }

        .history-dialog h2 {
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .history-dialog .load-btn:hover {
            background-color: var(--primary-dark) !important;
        }

        .history-dialog .delete-btn:hover {
            background-color: var(--danger-dark) !important;
        }

        /* Enhanced animations */
        .result-box, .translation-box {
            transition: all 0.3s ease;
        }

        .result-box.hidden, .translation-box.hidden {
            max-height: 0;
            opacity: 0;
            padding: 0;
            margin: 0;
            overflow: hidden;
            border: none;
        }

        /* Pulse animation for recording state */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(242, 139, 130, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(242, 139, 130, 0); }
            100% { box-shadow: 0 0 0 0 rgba(242, 139, 130, 0); }
        }

        .btn-danger {
            animation: pulse 1.5s infinite;
        }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: var(--bg-darker);
            color: var(--text-primary);
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            border: 1px solid var(--border-color);
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Keyboard shortcut indicator */
        .keyboard-shortcut {
            display: inline-block;
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 2px 5px;
            font-size: 12px;
            margin-left: 5px;
            vertical-align: middle;
            color: var(--text-secondary);
        }

        /* Styling for the progress indicator during speech recognition */
        .speech-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-top: 5px;
        }

        .speech-progress .bar {
            width: 3px;
            height: 15px;
            background-color: var(--primary-color);
            border-radius: 3px;
            animation: sound-wave 1s infinite ease-in-out;
        }

        .speech-progress .bar:nth-child(2) {
            animation-delay: 0.2s;
        }

        .speech-progress .bar:nth-child(3) {
            animation-delay: 0.4s;
        }

        .speech-progress .bar:nth-child(4) {
            animation-delay: 0.6s;
        }

        .speech-progress .bar:nth-child(5) {
            animation-delay: 0.8s;
        }

        @keyframes sound-wave {
            0% { height: 5px; }
            50% { height: 15px; }
            100% { height: 5px; }
        }

        @media (max-width: 600px) {
            .chat-container {
                border-radius: 0;
                max-width: 100%;
                height: 100vh;
                padding: 15px;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .controls-group {
                justify-content: space-between;
            }

            .text-area {
                min-height: 120px;
            }
            
            .history-dialog {
                width: 95%;
                max-height: 85vh;
            }
            
            .controls-group {
                width: 100%;
            }
            
            .icon-button {
                flex: none;
            }
            
            .text-area {
                font-size: 16px; /* Prevent iOS zoom on input */
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-title">
                <i class="fas fa-comments"></i> Trò chuyện với người nước ngoài
            </div>
        </div>

        <div class="tab-bar">
            <div class="tab active" data-lang="vi-VN">Tiếng Việt</div>
            <div class="tab" data-lang="ja-JP">Tiếng Nhật</div>
			<div class="tab" data-lang="en-US">English</div>
        </div>

        <div class="toolbar">
            <div class="controls-group">
                <button id="micBtn" class="icon-button btn-primary" title="Bắt đầu ghi âm" aria-label="Bắt đầu ghi âm">
                    <i class="fas fa-microphone"></i>
                </button><button id="suggestBtn"
                <button id="suggestBtn" class="icon-button btn-primary" title="Có phải bạn muốn nói là:" disabled aria-label="Gợi ý cách nói">
                    <i class="fas fa-lightbulb"></i>
                </button>
                <button id="speakBtn" class="icon-button btn-primary" title="Phát âm thanh" disabled aria-label="Phát âm thanh">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>

            <div class="controls-group">
                <button id="saveBtn" class="icon-button btn-secondary" title="Lưu vào lịch sử" disabled aria-label="Lưu vào lịch sử">
                    <i class="fas fa-save"></i>
                </button>
                <button id="historyBtn" class="icon-button btn-secondary" title="Xem lịch sử" aria-label="Xem lịch sử">
                    <i class="fas fa-history"></i>
                </button>
                <button id="clearBtn" class="icon-button btn-danger" title="Xóa tất cả" aria-label="Xóa tất cả">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>

        <div class="status" id="status">
            <i class="fas fa-info-circle"></i>
            <span>Nhấn nút microphone và nói...</span>
        </div>

        <div id="result" class="result-box hidden">
            <div class="message" id="message-text"></div>
        </div>

        <textarea id="editableText" class="text-area" placeholder="Tin nhắn của bạn sẽ xuất hiện ở đây..."></textarea>

        <div id="translation" class="translation-box">
            <div class="message" id="translation-text"></div>
        </div>

        <div class="loading hidden" id="loading">
            <div class="spinner"></div>
            <span>Đang xử lý...</span>
        </div>

        <div id="corrections" class="suggestions hidden">
            <div class="suggestions-title">
                <i class="fas fa-lightbulb"></i>
                <span id="suggestions-title-text">Có phải bạn muốn nói là:</span>
            </div>
            <div id="suggestions"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM elements
            const elements = {
                micBtn: document.getElementById('micBtn'),
                suggestBtn: document.getElementById('suggestBtn'),
                speakBtn: document.getElementById('speakBtn'),
                saveBtn: document.getElementById('saveBtn'),
                clearBtn: document.getElementById('clearBtn'),
                historyBtn: document.getElementById('historyBtn'),
                tabs: document.querySelectorAll('.tab'),
                messageText: document.getElementById('message-text'),
                translationText: document.getElementById('translation-text'),
                editableText: document.getElementById('editableText'),
                status: document.getElementById('status'),
                suggestions: document.getElementById('suggestions'),
                suggestionsTitle: document.getElementById('suggestions-title-text'),
                loading: document.getElementById('loading'),
                resultBox: document.getElementById('result'),
                translationBox: document.getElementById('translation'),
                correctionsBox: document.getElementById('corrections')
            };

            const GEMINI_API_KEY = "AIzaSyDaROReiR48rjfavf8Lk6XvphC6QxKPZo4";
            let recognition = null;
            let isRecording = false;
            let currentLang = 'vi-VN';
            
            // Buffer for interim speech recognition results
            let interimBuffer = '';
            let finalBuffer = '';
			let translationTimeout = null;

            // Toggle action buttons
            function toggleActionButtons(enabled) {
                elements.suggestBtn.disabled = !enabled;
                elements.speakBtn.disabled = !enabled;
                elements.saveBtn.disabled = !enabled;
            }

            // Call Gemini API
            async function fetchFromGemini(promptText) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'API request failed');
                    }

                    return response.json();
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    throw error;
                }
            }

            // Translate text based on current language
            async function translateText(text) {
                if (!text) return '';
				
				// Thêm delay 1-2 giây giữa các request
				await new Promise(resolve => setTimeout(resolve, 3500));
                
                let promptText;
                if (currentLang === 'vi-VN') {
                    promptText = `
                        Dịch câu tiếng Việt sau sang tiếng Nhật: "${text}"
                        Trả lời chỉ với bản dịch tiếng Nhật, không thêm giải thích hoặc định dạng khác.
                    `;
				}
				if (currentLang === 'en-US') {
					promptText = `
					  Bạn là trợ lý trò chuyện tiếng Anh. Hãy đề xuất 2-3 cách diễn đạt lại câu sau tự nhiên hơn để trò chuyện với người nước ngoài.
					  Câu: "${text}"
					  Trả về bằng JSON như sau:
					  {
						"corrected_text": "I’m sorry, can you repeat that?",
						"suggestions": [
						  "Xin lỗi, bạn có thể nhắc lại không?",
						  "Tôi không nghe rõ, bạn nói lại được không?",
						  "Bạn vui lòng nhắc lại lần nữa nhé?"
						]
					  }
					`;				
                } else {
                    promptText = `
                        Dịch câu tiếng Nhật sau sang tiếng Việt: "${text}"
                        Trả lời chỉ với bản dịch tiếng Việt, không thêm giải thích hoặc định dạng khác.
                    `;
                }
                
                const response = await fetchFromGemini(promptText);
                return response.candidates[0].content.parts[0].text.trim();
            }

            // Get improved text and suggestions
            async function getImprovedTextAndSuggestions(text, language) {
				console.log('Input text:', text);
				console.log('Current language:', language);
				
                const promptText = `
					Bạn là một trợ lý trò chuyện. Phân tích câu nói sau bằng ${language === 'ja-JP' ? 'tiếng Nhật' : (language === 'en-US' ? 'tiếng Anh' : 'tiếng Việt')} và đề xuất 2-3 cách diễn đạt tự nhiên hơn, phù hợp để trò chuyện hàng ngày.

					Câu nói: "${text}"

					Tất cả các gợi ý và câu đã cải thiện phải giữ nguyên bằng ngôn ngữ gốc (${language}).

					Trả lời theo định dạng JSON:
					{
					  "corrected_text": "câu đã chỉnh sửa",
					  "suggestions": ["gợi ý 1", "gợi ý 2", "gợi ý 3"]
					}
					`;						
                
                const response = await fetchFromGemini(promptText);
                const responseText = response.candidates[0].content.parts[0].text;
                const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('Không thể phân tích phản hồi từ Gemini');
                return JSON.parse(jsonMatch[0]);
				
				// Sau khi nhận response
				console.log('API response:', responseText);
				console.log('Parsed JSON:', jsonMatch ? JSON.parse(jsonMatch[0]) : null);
            }

            // Improved language detection
            function detectLanguage(text) {
                if (!text) return 'unknown';
                
                // Vietnamese detection
                const vietnameseRegex = /[àáảãạăắằẳẵặâấầẩẫậèéẻẽẹêếềểễệìíỉĩịòóỏõọôốồổỗộơớờởỡợùúủũụưứừửữựỳýỷỹỵđ]/i;
                if (vietnameseRegex.test(text)) return 'vi-VN';

                // Japanese detection
                const japaneseRegex = /[\u3000-\u303F\u3040-\u309F\u30A0-\u30FF\uFF00-\uFFEF\u4E00-\u9FAF]/;
                if (japaneseRegex.test(text)) return 'ja-JP';
                
                // Fallback to common word detection
                const commonVietnameseWords = [
                    'toi', 'ban', 'la', 'cua', 'di', 've', 'va', 'voi', 'cho', 'tu',
                    'den', 'trong', 'ngoai', 'len', 'xuong', 'giua', 'tai', 'nho', 'lon', 'rat'
                ];
                
                const wordCount = {};
                const words = text.toLowerCase().split(/\s+/);
                
                words.forEach(word => {
                    if (commonVietnameseWords.includes(word)) {
                        wordCount['vi-VN'] = (wordCount['vi-VN'] || 0) + 1;
                    }
                });
                
                if (wordCount['vi-VN'] > 0) return 'vi-VN';
                
                return 'unknown';
            }
			
			// Hiển thị bản dịch cho văn bản đầu vào
			async function displayTranslation(text) {
				if (!text) {
					elements.translationBox.classList.add('hidden');
					elements.translationText.textContent = '';
					return;
				}
				
				elements.loading.classList.remove('hidden');
				try {
					const translation = await translateText(text);
					elements.translationText.textContent = translation;
					elements.translationBox.classList.remove('hidden');
				} catch (error) {
					elements.status.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>Lỗi dịch: ${error.message}</span>`;
					console.error('Translation error:', error);
				} finally {
					elements.loading.classList.add('hidden');
				}
			}			

            // Text-to-speech
            function speakText() {
                const text = currentLang === 'vi-VN'
                    ? elements.translationText.textContent.trim() // Speak Japanese (translation) when in Vietnamese mode
                    : elements.editableText.value.trim(); // Speak Japanese (original) when in Japanese mode
                    
                if (!text) {
                    elements.status.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Không có văn bản để phát âm</span>';
                    return;
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = {
					'vi-VN': 'ja-JP',
					'ja-JP': 'vi-VN',
					'en-US': 'vi-VN'
				}[currentLang];
                utterance.rate = 0.9; // Slightly slower rate for better clarity
                utterance.pitch = 1;
                
                speechSynthesis.cancel(); // Clear any previous speech
                speechSynthesis.speak(utterance);

                elements.status.innerHTML = '<i class="fas fa-volume-up"></i><span>Đang phát âm...</span>';
                utterance.onend = () => {
                    elements.status.innerHTML = '<i class="fas fa-info-circle"></i><span>Sẵn sàng</span>';
                };
                
                utterance.onerror = (event) => {
                    elements.status.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>Lỗi phát âm: ${event.error}</span>`;
                };
            }

            // Display suggestions
            function displaySuggestions(suggestions) {
                elements.suggestionsTitle.textContent = {
                    'vi-VN': 'Có phải bạn muốn nói là:',
                    'ja-JP': 'もしかして言いたかったのは：',
					'en-US': 'Did you mean:'
				}[currentLang] || 'Suggestions:';

                const detectedLang = currentLang;
                elements.suggestions.innerHTML = `<ul>${suggestions.map(s => `<li>${s}</li>`).join('')}</ul>`;

                if (validSuggestions.length === 0) {
                    elements.suggestions.innerHTML = '<p>Không có gợi ý nào.</p>';
                } else {
                    elements.suggestions.innerHTML = `<ul>${validSuggestions.map(s => `<li>${s}</li>`).join('')}</ul>`;
                }

                elements.suggestions.querySelectorAll('li').forEach(li => {
                    li.addEventListener('click', async () => {
                        if (currentLang === 'ja-JP') {
							elements.status.innerHTML = '<i class="fas fa-info-circle"></i><span>Đây là ý nghĩa câu nói</span>';
                        } else {
						elements.editableText.value = li.textContent;
						toggleActionButtons(true);
						}
                    });
                });

                elements.correctionsBox.classList.toggle('hidden', validSuggestions.length === 0);
            }

            // Suggest improved expressions
            async function suggestImprovedExpression() {
                const text = elements.editableText.value.trim();
                if (!text) {
                    elements.status.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Không có tin nhắn để gợi ý</span>';
                    return;
                }

                elements.loading.classList.remove('hidden');
                elements.suggestBtn.disabled = true;

                try {
                    const result = await getImprovedTextAndSuggestions(text, currentLang);
                    
                    // Verify language match for corrected text
                    const correctedTextLang = detectLanguage(result.corrected_text);
                    if (correctedTextLang !== 'unknown' && correctedTextLang !== currentLang) {
                        elements.status.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Câu cải thiện không phù hợp ngôn ngữ, vui lòng thử lại.</span>';
                    } else {
                        elements.editableText.value = result.corrected_text || text;
                        displaySuggestions(result.suggestions || []);
                    }
                } catch (error) {
                    elements.status.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>Lỗi: ${error.message}</span>`;
                } finally {
                    elements.loading.classList.add('hidden');
                    elements.suggestBtn.disabled = false;
                }
            }

            // Clear all content
            function clearAll() {
                elements.editableText.value = '';
                elements.messageText.textContent = '';
                elements.translationText.textContent = '';
                elements.suggestions.innerHTML = '';
                elements.resultBox.classList.add('hidden');
                elements.translationBox.classList.add('hidden');
                elements.correctionsBox.classList.add('hidden');
                toggleActionButtons(false);
                elements.status.innerHTML = '<i class="fas fa-info-circle"></i><span>Sẵn sàng</span>';
                
                // Clear buffers
                interimBuffer = '';
                finalBuffer = '';
            }

            // Setup Web Speech API
            function setupRecognition() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    elements.status.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Trình duyệt không hỗ trợ nhận diện giọng nói. Hãy dùng Chrome.</span>';
                    elements.micBtn.disabled = true;
                    return;
                }

                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = currentLang;
                recognition.interimResults = true;
                recognition.continuous = true;
                recognition.maxAlternatives = 1;

                recognition.onresult = async event => {
                    const result = event.results[event.results.length - 1];
                    const transcript = result[0].transcript;

                    if (result.isFinal) {
                        // For final results, append to the final buffer
                        finalBuffer += (finalBuffer ? ' ' : '') + transcript.trim();
                        
                        // Update the editable field with all final results
                        elements.editableText.value = finalBuffer;
                        
                        // Clear the interim display
                        interimBuffer = '';
                        elements.messageText.textContent = '';
                        elements.resultBox.classList.add('hidden');
                        
                        // Enable action buttons
                        toggleActionButtons(true);
						
						if (translationTimeout) clearTimeout(translationTimeout); // hủy nếu có timer cũ						
										
					} else {
                        // For interim results, show in the interim result box
                        interimBuffer = transcript;
                        elements.messageText.textContent = interimBuffer;
                        elements.resultBox.classList.remove('hidden');
                    }
                };										

                recognition.onstart = () => {
                    isRecording = true;
                    elements.status.innerHTML = '<i class="fas fa-microphone"></i><span>Đang nghe... Nói điều gì đó</span>';
                    elements.micBtn.innerHTML = '<i class="fas fa-stop"></i>';
                    elements.micBtn.title = 'Dừng ghi âm';
                    elements.micBtn.classList.replace('btn-primary', 'btn-danger');
                };

                recognition.onend = () => {
                    isRecording = false;
                    elements.status.innerHTML = '<i class="fas fa-check-circle"></i><span>Đã dừng ghi âm</span>';
                    elements.micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    elements.micBtn.title = 'Bắt đầu ghi âm';
                    elements.micBtn.classList.replace('btn-danger', 'btn-primary');
                    toggleActionButtons(!!elements.editableText.value.trim());
                };

                recognition.onerror = event => {
                    isRecording = false;
                    elements.micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    elements.micBtn.title = 'Bắt đầu ghi âm';
                    elements.micBtn.classList.replace('btn-danger', 'btn-primary');
                    
                    const errorMessages = {
                        'no-speech': 'Không phát hiện giọng nói',
                        'audio-capture': 'Không thể truy cập microphone',
                        'not-allowed': 'Microphone bị chặn',
                        'network': 'Lỗi kết nối mạng',
                        'aborted': 'Nhận diện bị hủy',
                        default: `Lỗi: ${event.error}`
                    };
                    
                    elements.status.innerHTML = `<i class="fas fa-exclamation-circle"></i><span>${errorMessages[event.error] || errorMessages.default}</span>`;
                };
            }

            // Handle tab switching
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Update tab UI
                    elements.tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update language and placeholder
                    currentLang = tab.dataset.lang;
                    elements.editableText.placeholder = {
                        'vi-VN': 'Tin nhắn của bạn sẽ xuất hiện ở đây...',
                        'ja-JP': 'メッセージはここに表示されます...',
						'en-US': 'Your message will appear here...'
					}[currentLang];
                    
                    // Reset buffers on language change
                    interimBuffer = '';
                    finalBuffer = elements.editableText.value.trim();
                    
                    // Update recognition language
                    if (recognition) {
                        const wasRecording = isRecording;
                        if (wasRecording) recognition.stop();
                        recognition.lang = currentLang;
                        if (wasRecording) setTimeout(() => recognition.start(), 100);
                    }
                    
                    elements.status.innerHTML = `<i class="fas fa-info-circle"></i><span>Đã chuyển sang ${currentLang === 'vi-VN' ? 'Tiếng Việt' : 'Tiếng Nhật'}</span>`;
                    
                    // Retranslate current text if exists
                    if (elements.editableText.value.trim()) {
                        displayTranslation(elements.editableText.value.trim());
                    }
                });
            });

            // Event listeners
            elements.editableText.addEventListener('input', () => {
                // Update final buffer when user types directly
                finalBuffer = elements.editableText.value.trim();
                toggleActionButtons(!!finalBuffer);
                displayTranslation(finalBuffer);
            });

            elements.micBtn.addEventListener('click', () => {
				localStorage.removeItem('autosave');
                if (!recognition) setupRecognition();
                
                if (!isRecording) {
                    // If starting a new recording session
                    if (!elements.editableText.value.trim()) {
                        // Clear buffers if textarea is empty
                        finalBuffer = '';
                        interimBuffer = '';
                    }
                    recognition.start();
                } else {
                    recognition.stop();
                }
            });

            elements.suggestBtn.addEventListener('click', suggestImprovedExpression);

            elements.speakBtn.addEventListener('click', speakText);

            elements.saveBtn.addEventListener('click', () => {
                const textToSave = elements.editableText.value.trim();
                if (!textToSave) return;
                
                const translationToSave = elements.translationText.textContent.trim();
                
                const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
                history.push({
                    text: textToSave,
                    translation: translationToSave,
                    language: currentLang,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('chatHistory', JSON.stringify(history));
                elements.status.innerHTML = '<i class="fas fa-check-circle"></i><span>Đã lưu!</span>';
                setTimeout(() => {
                    elements.status.innerHTML = '<i class="fas fa-info-circle"></i><span>Sẵn sàng</span>';
                }, 2000);
            });

            elements.clearBtn.addEventListener('click', clearAll);

            // Show history
            elements.historyBtn.addEventListener('click', showHistory);

            // Initialize
            setupRecognition();

            // Add support for keyboard shortcuts
            document.addEventListener('keydown', (event) => {
                // Space key to toggle recording (only when no input fields are focused)
                if (event.code === 'Space' && document.activeElement !== elements.editableText) {
                    event.preventDefault();
                    elements.micBtn.click();
                }
                
                // Ctrl+Enter or Cmd+Enter to suggest improved expressions
                if ((event.ctrlKey || event.metaKey) && event.code === 'Enter' && !elements.suggestBtn.disabled) {
                    event.preventDefault();
                    elements.suggestBtn.click();
                }
                
                // Alt+S to speak text
                if (event.altKey && event.code === 'KeyS' && !elements.speakBtn.disabled) {
                    event.preventDefault();
                    elements.speakBtn.click();
                }
            });

            // History viewer functionality
            function showHistory() {
                const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
                if (history.length === 0) {
                    elements.status.innerHTML = '<i class="fas fa-info-circle"></i><span>Lịch sử trống</span>';
                    return;
                }
                
                // Create a dialog to show history
                const historyDialog = document.createElement('div');
                historyDialog.classList.add('history-dialog');
                historyDialog.style.position = 'fixed';
                historyDialog.style.top = '50%';
                historyDialog.style.left = '50%';
                historyDialog.style.transform = 'translate(-50%, -50%)';
                historyDialog.style.backgroundColor = 'var(--bg-card)';
                historyDialog.style.padding = '20px';
                historyDialog.style.borderRadius = 'var(--border-radius)';
                historyDialog.style.boxShadow = 'var(--box-shadow)';
                historyDialog.style.zIndex = '1000';
                historyDialog.style.maxWidth = '90%';
                historyDialog.style.maxHeight = '80vh';
                historyDialog.style.overflow = 'auto';
                historyDialog.style.border = '1px solid var(--border-color)';
                
                // Add close button
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '<i class="fas fa-times"></i>';
                closeBtn.style.position = 'absolute';
                closeBtn.style.top = '10px';
                closeBtn.style.right = '10px';
                closeBtn.style.background = 'transparent';
                closeBtn.style.border = 'none';
                closeBtn.style.color = 'var(--text-primary)';
                closeBtn.style.cursor = 'pointer';
                closeBtn.style.fontSize = '16px';
                closeBtn.addEventListener('click', () => {
                    document.body.removeChild(historyDialog);
                    document.body.removeChild(overlay);
                });
                
                // Add title
                const title = document.createElement('h2');
                title.textContent = 'Lịch sử trò chuyện';
                title.style.marginBottom = '15px';
                title.style.color = 'var(--primary-color)';
                
                historyDialog.appendChild(closeBtn);
                historyDialog.appendChild(title);
                
                // Add history items
                const historyList = document.createElement('div');
                historyList.style.display = 'flex';
                historyList.style.flexDirection = 'column';
                historyList.style.gap = '10px';
                
                history.reverse().forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.style.padding = '10px';
                    historyItem.style.backgroundColor = 'var(--bg-darker)';
                    historyItem.style.borderRadius = 'var(--border-radius)';
                    historyItem.style.border = '1px solid var(--border-color)';
                    
                    const dateOptions = { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    };
                    const formattedDate = new Date(item.timestamp).toLocaleString('vi-VN', dateOptions);
                    
                    historyItem.innerHTML = `
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px">
                            <span style="color:var(--text-secondary); font-size:14px">
                                ${item.language === 'vi-VN' ? 'Tiếng Việt' : 'Tiếng Nhật'}
                            </span>
                            <span style="color:var(--text-secondary); font-size:14px">${formattedDate}</span>
                        </div>
                        <div style="margin-bottom:5px">${item.text}</div>
                        ${item.translation ? `
                            <div style="color:var(--text-secondary); margin-top:5px; padding-top:5px; border-top:1px solid var(--border-color)">
                                ${item.translation}
                            </div>
                        ` : ''}
                        <div style="display:flex; gap:5px; margin-top:10px; justify-content:flex-end">
                            <button class="load-btn" style="background:var(--primary-color); color:#202124; border:none; padding:5px 10px; border-radius:4px; cursor:pointer">
                                <i class="fas fa-upload"></i> Tải lên
                            </button>
                            <button class="delete-btn" style="background:var(--danger-color); color:#202124; border:none; padding:5px 10px; border-radius:4px; cursor:pointer">
                                <i class="fas fa-trash"></i> Xóa
                            </button>
                        </div>
                    `;
                    
                    // Add event listeners to buttons
                    historyItem.querySelector('.load-btn').addEventListener('click', () => {
                        elements.editableText.value = item.text;
                        finalBuffer = item.text;
                        toggleActionButtons(true);
                        displayTranslation(item.text);
                        document.body.removeChild(historyDialog);
                        document.body.removeChild(overlay);
                    });
                    
                    historyItem.querySelector('.delete-btn').addEventListener('click', () => {
                        history.splice(history.length - 1 - index, 1);
                        localStorage.setItem('chatHistory', JSON.stringify(history));
                        historyItem.style.opacity = '0.5';
                        historyItem.style.pointerEvents = 'none';
                        setTimeout(() => {
                            historyList.removeChild(historyItem);
                            if (historyList.children.length === 0) {
                                document.body.removeChild(historyDialog);
                                document.body.removeChild(overlay);
                                elements.status.innerHTML = '<i class="fas fa-info-circle"></i><span>Lịch sử trống</span>';
                            }
                        }, 500);
                    });
                    
                    historyList.appendChild(historyItem);
                });
                
                historyDialog.appendChild(historyList);
                
                // Add overlay
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.backgroundColor = 'rgba(0,0,0,0.7)';
                overlay.style.zIndex = '999';
                overlay.addEventListener('click', () => {
                    document.body.removeChild(historyDialog);
                    document.body.removeChild(overlay);
                });
                
                document.body.appendChild(overlay);
                document.body.appendChild(historyDialog);
            }

            // Add error handling for the Web Speech API
            window.addEventListener('error', (event) => {
                if (event.message.includes('speech') || event.message.includes('recognition')) {
                    elements.status.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>Lỗi nhận diện giọng nói: ${event.message}</span>`;
                }
            });

            // Check for browser compatibility on load
            function checkCompatibility() {
                // Check for Speech Recognition API
                const speechRecognitionAvailable = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
                
                // Check for Speech Synthesis API
                const speechSynthesisAvailable = 'speechSynthesis' in window;
                
                if (!speechRecognitionAvailable) {
                    elements.status.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Trình duyệt không hỗ trợ nhận diện giọng nói. Hãy dùng Chrome hoặc Edge.</span>';
                    elements.micBtn.disabled = true;
                }
                
                if (!speechSynthesisAvailable) {
                    elements.speakBtn.disabled = true;
                    elements.speakBtn.title = 'Trình duyệt không hỗ trợ phát âm';
                }
            }

            // Check network connection
            function checkNetwork() {
                const updateNetworkStatus = () => {
                    if (!navigator.onLine) {
                        elements.status.innerHTML = '<i class="fas fa-wifi"></i><span>Không có kết nối mạng</span>';
                        elements.suggestBtn.disabled = true;
                    } else {
                        elements.status.innerHTML = '<i class="fas fa-info-circle"></i><span>Kết nối đã được khôi phục</span>';
                        toggleActionButtons(!!elements.editableText.value.trim());
                    }
                };
                
                window.addEventListener('online', updateNetworkStatus);
                window.addEventListener('offline', updateNetworkStatus);
                
                // Initial check
                if (!navigator.onLine) {
                    elements.status.innerHTML = '<i class="fas fa-wifi"></i><span>Không có kết nối mạng</span>';
                }
            }

            // Run compatibility checks
            checkCompatibility();
            checkNetwork();

            // Add window focus/blur event listeners to handle recording state
            window.addEventListener('blur', () => {
                if (isRecording) {
                    recognition.stop();
                    elements.status.innerHTML = '<i class="fas fa-pause-circle"></i><span>Ghi âm tạm dừng do chuyển tab</span>';
                }
            });

            // Add support for swipe gestures on mobile
            let touchStartX = 0;
            let touchEndX = 0;

            document.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });

            document.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });

            function handleSwipe() {
                // Minimum swipe distance (in pixels)
                const swipeThreshold = 100;
                
                if (touchEndX < touchStartX - swipeThreshold) {
                    // Swipe left - switch to Japanese
                    if (currentLang !== 'ja-JP') {
                        document.querySelector('.tab[data-lang="ja-JP"]').click();
                    }
                }
                
                if (touchEndX > touchStartX + swipeThreshold) {
                    // Swipe right - switch to Vietnamese
                    if (currentLang !== 'vi-VN') {
                        document.querySelector('.tab[data-lang="vi-VN"]').click();
                    }
                }
            }

            // Add functionality to clear interim results without stopping recognition
            function clearInterimResults() {
                if (isRecording) {
                    elements.messageText.textContent = '';
                    elements.resultBox.classList.add('hidden');
                    interimBuffer = '';
                }
            }

            // Add double-tap on mic button to clear interim results
            let lastTap = 0;
            elements.micBtn.addEventListener('dblclick', (e) => {
                e.preventDefault();
                clearInterimResults();
            });

            // For mobile
            elements.micBtn.addEventListener('touchend', (e) => {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 500 && tapLength > 0) {
                    clearInterimResults();
                    e.preventDefault();
                }
                lastTap = currentTime;
            });

            // Add autosave functionality
            setInterval(() => {
                const textToSave = elements.editableText.value.trim();
                if (textToSave) {
                    localStorage.setItem('autosave', JSON.stringify({
                        text: textToSave,
                        language: currentLang,
                        translation: elements.translationText.textContent.trim(),
                        timestamp: new Date().toISOString()
                    }));
                }
            }, 10000); // Autosave every 10 seconds

            // Check for autosaved content on load
            const autosaved = localStorage.getItem('autosave');
            if (autosaved) {
                try {
                    const savedData = JSON.parse(autosaved);
                    if (savedData.text && new Date().getTime() - new Date(savedData.timestamp).getTime() < 24 * 60 * 60 * 1000) {
                        // Only restore if less than 24 hours old
                        elements.editableText.value = savedData.text;
                        finalBuffer = savedData.text;
                        
                        // Switch to the correct language tab if needed
                        if (savedData.language && savedData.language !== currentLang) {
                            document.querySelector(`.tab[data-lang="${savedData.language}"]`).click();
                        } else {
                            // Just display translation if language is already correct
                            displayTranslation(savedData.text);
                        }
                        
                        toggleActionButtons(true);
                        elements.status.innerHTML = '<i class="fas fa-history"></i><span>Nội dung tự động lưu đã được khôi phục</span>';
                    }
                } catch (e) {
                    console.error('Error loading autosaved content:', e);
                }
            }
        });
    </script>
</body>
</html>
