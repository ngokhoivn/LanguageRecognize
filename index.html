<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #8ab4f8;
            --primary-dark: #7ba3e6;
            --secondary-color: #81c995;
            --secondary-dark: #72b586;
            --danger-color: #f28b82;
            --danger-dark: #e37b72;
            --bg-dark: #121212;
            --bg-darker: #0a0a0a;
            --bg-card: #1e1e1e;
            --text-primary: #e1e1e1;
            --text-secondary: #b0b0b0;
            --border-color: #333333;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        .chat-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .chat-title {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--primary-color);
        }

        .tab-bar {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: var(--bg-darker);
            cursor: pointer;
            transition: background 0.3s;
        }

        .tab.active {
            background: var(--primary-color);
            color: #202124;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 10px;
			justify-content: space-between;
        }

        .controls-group {
            display: flex;
            gap: 8px;
            align-items: center;
			flex-wrap: nowrap;
			overflow-x: auto;
        }

        .icon-button {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: var(--bg-darker);
            color: var(--text-primary);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: #202124;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: #202124;
        }

        .btn-secondary:hover {
            background-color: var(--secondary-dark);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: #202124;
        }

        .btn-danger:hover {
            background-color: var(--danger-dark);
        }

        button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
            opacity: 0.5;
            color: var(--text-secondary);
        }

        .text-area {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
            background-color: var(--bg-darker);
            color: var(--text-primary);
        }

        .text-area:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(138, 180, 248, 0.2);
        }

        .text-area::placeholder {
            color: var(--text-secondary);
        }

        .result-box {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-darker);
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .translation-box {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-darker);
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .status {
            padding: 12px 15px;
            background-color: var(--bg-darker);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .status i {
            color: var(--primary-color);
        }

        .loading {
            padding: 15px;
            background-color: var(--bg-darker);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: 1px solid var(--border-color);
        }

        .loading.hidden {
            display: none;
        }

        .loading span {
            color: var(--text-primary);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .suggestions {
            margin-top: 10px;
            color: var(--text-primary);
        }

        .suggestions-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .suggestions ul {
            padding-left: 20px;
            margin-top: 8px;
        }

        .suggestions li {
            margin-bottom: 8px;
            line-height: 1.5;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .suggestions li:hover {
            color: var(--primary-color);
        }

        .hidden {
            display: none !important;
        }

        /* History dialog styles */
        .history-dialog {
            display: flex;
            flex-direction: column;
            color: var(--text-primary);
        }

        .history-dialog h2 {
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .history-dialog .load-btn:hover {
            background-color: var(--primary-dark) !important;
        }

        .history-dialog .delete-btn:hover {
            background-color: var(--danger-dark) !important;
        }

        /* Enhanced animations */
        .result-box, .translation-box {
            transition: all 0.3s ease;
        }

        .result-box.hidden, .translation-box.hidden {
            max-height: 0;
            opacity: 0;
            padding: 0;
            margin: 0;
            overflow: hidden;
            border: none;
        }

        /* Pulse animation for recording state */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(242, 139, 130, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(242, 139, 130, 0); }
            100% { box-shadow: 0 0 0 0 rgba(242, 139, 130, 0); }
        }

        .btn-danger {
            animation: pulse 1.5s infinite;
        }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: var(--bg-darker);
            color: var(--text-primary);
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            border: 1px solid var(--border-color);
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Keyboard shortcut indicator */
        .keyboard-shortcut {
            display: inline-block;
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 2px 5px;
            font-size: 12px;
            margin-left: 5px;
            vertical-align: middle;
            color: var(--text-secondary);
        }

        /* Styling for the progress indicator during speech recognition */
        .speech-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-top: 5px;
        }

        .speech-progress .bar {
            width: 3px;
            height: 15px;
            background-color: var(--primary-color);
            border-radius: 3px;
            animation: sound-wave 1s infinite ease-in-out;
        }

        .speech-progress .bar:nth-child(2) {
            animation-delay: 0.2s;
        }

        .speech-progress .bar:nth-child(3) {
            animation-delay: 0.4s;
        }

        .speech-progress .bar:nth-child(4) {
            animation-delay: 0.6s;
        }

        .speech-progress .bar:nth-child(5) {
            animation-delay: 0.8s;
        }

        @keyframes sound-wave {
            0% { height: 5px; }
            50% { height: 15px; }
            100% { height: 5px; }
        }

        @media (max-width: 600px) {
            .chat-container {
                border-radius: 0;
                max-width: 100%;
                height: 100vh;
                padding: 15px;
            }

            .toolbar {
                flex-direction: row;
                flex-wrap: nowrap;
				overflow-x: auto;
				gap: 8px;
            }

            .controls-group {
                justify-content: space-between;
            }

            .text-area {
                min-height: 120px;
            }
            
            .history-dialog {
                width: 95%;
                max-height: 85vh;
            }
            
            .controls-group {
                width: 100%;
            }
            
            .icon-button {
                flex: none;
            }
            
            .text-area {
                font-size: 16px; /* Prevent iOS zoom on input */
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-title">
                <i class="fas fa-comments"></i> Trò chuyện với người nước ngoài
            </div>
        </div>

        <div class="tab-bar">
            <div class="tab active" data-lang="vi-VN">Tiếng Việt</div>
            <div class="tab" data-lang="ja-JP">Tiếng Nhật</div>
			<div class="tab" data-lang="en-US">English</div>
        </div>

        <div class="toolbar">
            <div class="controls-group">
                <button id="micBtn" class="icon-button btn-primary" title="Bắt đầu ghi âm" aria-label="Bắt đầu ghi âm">
                    <i class="fas fa-microphone"></i>
                </button><button id="suggestBtn"
                <button id="suggestBtn" class="icon-button btn-primary" title="Có phải bạn muốn nói là:" disabled aria-label="Gợi ý cách nói">
                    <i class="fas fa-lightbulb"></i>
                </button>
                <button id="speakBtn" class="icon-button btn-primary" title="Phát âm thanh" disabled aria-label="Phát âm thanh">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>

            <div class="controls-group">
                <button id="saveBtn" class="icon-button btn-secondary" title="Lưu vào lịch sử" disabled aria-label="Lưu vào lịch sử">
                    <i class="fas fa-save"></i>
                </button>
                <button id="historyBtn" class="icon-button btn-secondary" title="Xem lịch sử" aria-label="Xem lịch sử">
                    <i class="fas fa-history"></i>
                </button>
                <button id="clearBtn" class="icon-button btn-danger" title="Xóa tất cả" aria-label="Xóa tất cả">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>

        <div class="status" id="status">
            <i class="fas fa-info-circle"></i>
            <span>Nhấn nút microphone và nói...</span>
        </div>

        <div id="result" class="result-box hidden">
            <div class="message" id="message-text"></div>
        </div>

        <textarea id="editableText" class="text-area" placeholder="Tin nhắn của bạn sẽ xuất hiện ở đây..."></textarea>

        <div id="translation" class="translation-box">
            <div class="message" id="translation-text"></div>
        </div>

        <div class="loading hidden" id="loading">
            <div class="spinner"></div>
            <span>Đang xử lý...</span>
        </div>

        <div id="corrections" class="suggestions hidden">
            <div class="suggestions-title">
                <i class="fas fa-lightbulb"></i>
                <span id="suggestions-title-text">Có phải bạn muốn nói là:</span>
            </div>
            <div id="suggestions"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM elements
            const elements = {
                micBtn: document.getElementById('micBtn'),
                suggestBtn: document.getElementById('suggestBtn'),
                speakBtn: document.getElementById('speakBtn'),
                saveBtn: document.getElementById('saveBtn'),
                clearBtn: document.getElementById('clearBtn'),
                historyBtn: document.getElementById('historyBtn'),
                tabs: document.querySelectorAll('.tab'),
                messageText: document.getElementById('message-text'),
                translationText: document.getElementById('translation-text'),
                editableText: document.getElementById('editableText'),
                status: document.getElementById('status'),
                suggestions: document.getElementById('suggestions'),
                suggestionsTitle: document.getElementById('suggestions-title-text'),
                loading: document.getElementById('loading'),
                resultBox: document.getElementById('result'),
                translationBox: document.getElementById('translation'),
                correctionsBox: document.getElementById('corrections')
            };

            const GEMINI_API_KEY = "AIzaSyDaROReiR48rjfavf8Lk6XvphC6QxKPZo4";
			// Speech Recognition Logic
			let recognition = null;
			let isRecording = false;
			let recognitionTimeout = null;
			let translationDebounceTimer = null;
			let finalTranscript = '';
			let interimTranscript = '';
			let recognitionPaused = false;
			let lastRecognitionResult = '';
			let consecutiveSilenceCount = 0;

			// Initialize Web Speech API
			function initSpeechRecognition() {
				// Check browser support
				if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
					showStatus('error', 'Trình duyệt không hỗ trợ nhận diện giọng nói. Hãy dùng Chrome hoặc Edge.');
					elements.micBtn.disabled = true;
					return false;
				}

				try {
					// Create recognition instance
					recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
					
					// Configure settings
					recognition.lang = currentLang;
					recognition.interimResults = true;
					recognition.continuous = true;
					recognition.maxAlternatives = 3;

					// Handle recognition results
					recognition.onresult = handleRecognitionResult;
					
					// Handle events
					recognition.onstart = handleRecognitionStart;
					recognition.onend = handleRecognitionEnd;
					recognition.onerror = handleRecognitionError;
					recognition.onnomatch = () => {
						showStatus('warning', 'Không nhận diện được. Vui lòng thử lại.');
					};
					
					return true;
				} catch (error) {
					console.error("Error initializing speech recognition:", error);
					showStatus('error', `Lỗi khởi tạo: ${error.message}`);
					return false;
				}
			}

			// Handle speech recognition results
			function handleRecognitionResult(event) {
				// Reset the silence counter since we got a result
				consecutiveSilenceCount = 0;
				
				// Get the current recognition result
				let interimResult = '';
				let finalResult = '';
				
				// Process all results in this event
				for (let i = event.resultIndex; i < event.results.length; i++) {
					const transcript = event.results[i][0].transcript.trim();
					
					if (event.results[i].isFinal) {
						finalResult += transcript + ' ';
						// Clear any interim display of this text
						interimTranscript = interimTranscript.replace(transcript, '').trim();
					} else {
						interimResult += transcript + ' ';
					}
				}
				
				// Update our transcripts
				if (finalResult) {
					finalTranscript += finalResult;
					lastRecognitionResult = finalResult;
					
					// Update the editable field with clean content
					elements.editableText.value = finalTranscript.trim();
					
					// Schedule translation with debounce
					scheduleTranslation(finalTranscript.trim());
					
					// Enable action buttons when we have final text
					toggleActionButtons(true);
				}
				
				// Update interim display
				if (interimResult) {
					interimTranscript = interimResult;
					elements.messageText.textContent = interimTranscript;
					elements.resultBox.classList.remove('hidden');
				} else if (!interimTranscript) {
					// Hide interim box if no interim text
					elements.messageText.textContent = '';
					elements.resultBox.classList.add('hidden');
				}
			}

			// Start speech recognition with error handling
			function startRecognition() {
				try {
					if (!recognition) {
						if (!initSpeechRecognition()) return;
					}
					
					// Configure for current language
					recognition.lang = currentLang;
					
					// Start recording
					recognition.start();
					isRecording = true;
					recognitionPaused = false;
					
					// Update UI
					updateMicButtonState(true);
					showStatus('recording', 'Đang nghe... Nói điều gì đó');
					
					// Set up silence detection
					startSilenceDetection();
				} catch (error) {
					console.error("Error starting recognition:", error);
					showStatus('error', `Không thể bắt đầu ghi âm: ${error.message}`);
					updateMicButtonState(false);
				}
			}

			// Stop speech recognition with error handling
			function stopRecognition() {
				try {
					if (recognition) {
						recognition.stop();
					}
					
					// Clear silence detection
					if (recognitionTimeout) {
						clearTimeout(recognitionTimeout);
						recognitionTimeout = null;
					}
					
					// Update state
					isRecording = false;
					recognitionPaused = false;
					
					// Update UI
					updateMicButtonState(false);
					showStatus('ready', 'Đã dừng ghi âm');
				} catch (error) {
					console.error("Error stopping recognition:", error);
					showStatus('error', `Lỗi khi dừng ghi âm: ${error.message}`);
				}
			}

			// Handle recognition start event
			function handleRecognitionStart() {
				isRecording = true;
				updateMicButtonState(true);
				
				// Add visual indicator for recording
				const speechProgressIndicator = document.createElement('div');
				speechProgressIndicator.className = 'speech-progress';
				speechProgressIndicator.innerHTML = `
					<div class="bar"></div>
					<div class="bar"></div>
					<div class="bar"></div>
					<div class="bar"></div>
					<div class="bar"></div>
				`;
				elements.status.appendChild(speechProgressIndicator);
			}

			// Handle recognition end event
			function handleRecognitionEnd() {
				isRecording = false;
				updateMicButtonState(false);
				
				// Process any pending interim results if we have them
				if (interimTranscript.trim()) {
					finalTranscript += interimTranscript.trim() + ' ';
					elements.editableText.value = finalTranscript.trim();
					scheduleTranslation(finalTranscript.trim());
					
					// Clear interim display
					interimTranscript = '';
					elements.messageText.textContent = '';
					elements.resultBox.classList.add('hidden');
				}
				
				// Enable buttons if we have text
				toggleActionButtons(!!elements.editableText.value.trim());
				
				// Auto-restart if speech ended unexpectedly but not paused or stopped manually
				if (isRecording && !recognitionPaused) {
					console.log("Recognition ended unexpectedly, restarting...");
					setTimeout(() => {
						if (isRecording && !recognitionPaused) {
							try {
								recognition.start();
							} catch (e) {
								console.error("Failed to restart recognition:", e);
								isRecording = false;
								showStatus('error', 'Không thể tiếp tục ghi âm');
							}
						}
					}, 500);
				}
			}

			// Handle recognition errors
			function handleRecognitionError(event) {
				console.error("Recognition error:", event.error);
				
				const errorMessages = {
					'no-speech': 'Không phát hiện giọng nói',
					'audio-capture': 'Không thể truy cập microphone',
					'not-allowed': 'Vui lòng cho phép truy cập microphone',
					'network': 'Lỗi kết nối mạng',
					'aborted': 'Nhận diện bị hủy',
					'language-not-supported': 'Ngôn ngữ không được hỗ trợ',
					'service-not-allowed': 'Dịch vụ nhận diện không có sẵn',
					'bad-grammar': 'Lỗi ngữ pháp nhận diện',
					default: `Lỗi nhận diện: ${event.error}`
				};
				
				const errorMessage = errorMessages[event.error] || errorMessages.default;
				
				// Fatal errors that should stop recognition
				if (['not-allowed', 'audio-capture', 'network', 'language-not-supported', 'service-not-allowed'].includes(event.error)) {
					isRecording = false;
					recognitionPaused = false;
					updateMicButtonState(false);
					showStatus('error', errorMessage);
				} else {
					// Non-fatal errors, show warning but continue if still recording
					showStatus('warning', errorMessage);
					
					// Try to restart recognition for non-fatal errors
					if (isRecording && !recognitionPaused) {
						setTimeout(() => {
							try {
								recognition.start();
							} catch (e) {
								console.error("Failed to restart after error:", e);
								isRecording = false;
								showStatus('error', 'Không thể tiếp tục ghi âm');
								updateMicButtonState(false);
							}
						}, 1000);
					}
				}
			}

			// Update the mic button appearance based on recording state
			function updateMicButtonState(recording) {
				if (recording) {
					elements.micBtn.innerHTML = '<i class="fas fa-stop"></i>';
					elements.micBtn.title = 'Dừng ghi âm';
					elements.micBtn.classList.replace('btn-primary', 'btn-danger');
				} else {
					elements.micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
					elements.micBtn.title = 'Bắt đầu ghi âm';
					elements.micBtn.classList.replace('btn-danger', 'btn-primary');
				}
			}

			// Show status message with appropriate icon
			function showStatus(type, message) {
				const icons = {
					'info': 'fa-info-circle',
					'success': 'fa-check-circle',
					'warning': 'fa-exclamation-circle',
					'error': 'fa-exclamation-triangle',
					'recording': 'fa-microphone',
					'processing': 'fa-cog fa-spin',
					'ready': 'fa-info-circle'
				};
				
				elements.status.innerHTML = `<i class="fas ${icons[type] || icons.info}"></i><span>${message}</span>`;
				
				// Add visual indicator for recording state
				if (type === 'recording') {
					const speechProgressIndicator = document.createElement('div');
					speechProgressIndicator.className = 'speech-progress';
					speechProgressIndicator.innerHTML = `
						<div class="bar"></div>
						<div class="bar"></div>
						<div class="bar"></div>
						<div class="bar"></div>
						<div class="bar"></div>
					`;
					elements.status.appendChild(speechProgressIndicator);
				}
			}

			// Toggle recognition on/off
			function toggleRecognition() {
				if (isRecording) {
					stopRecognition();
				} else {
					// Clear buffers if starting fresh
					if (!elements.editableText.value.trim()) {
						finalTranscript = '';
						interimTranscript = '';
					} else {
						// If continuing with existing text, initialize final transcript
						finalTranscript = elements.editableText.value.trim() + ' ';
					}
					
					startRecognition();
				}
			}

			// Schedule translation with debounce
			function scheduleTranslation(text) {
				// Clear any pending translation
				if (translationDebounceTimer) {
					clearTimeout(translationDebounceTimer);
				}
				
				// Schedule new translation with delay
				translationDebounceTimer = setTimeout(() => {
					displayTranslation(text);
				}, 800); // 800ms debounce
			}

			// Detect silence to auto-stop recording after period of silence
			function startSilenceDetection() {
				if (recognitionTimeout) {
					clearTimeout(recognitionTimeout);
				}
				
				recognitionTimeout = setTimeout(() => {
					// Check if we're still recording and have had no new results
					if (isRecording) {
						consecutiveSilenceCount++;
						
						// After 5 silence checks (about 10 seconds), auto-stop
						if (consecutiveSilenceCount >= 5) {
							console.log("Silence detected, stopping recognition");
							stopRecognition();
							showStatus('info', 'Đã dừng ghi âm do im lặng');
							return;
						}
						
						// Continue checking for silence
						startSilenceDetection();
					}
				}, 2000); // Check every 2 seconds
			}

			// Reset recognition for new session
			function resetRecognition() {
				// Stop any active recognition
				if (isRecording) {
					stopRecognition();
				}
				
				// Clear all timers
				if (recognitionTimeout) {
					clearTimeout(recognitionTimeout);
					recognitionTimeout = null;
				}
				
				if (translationDebounceTimer) {
					clearTimeout(translationDebounceTimer);
					translationDebounceTimer = null;
				}
				
				// Clear transcripts
				finalTranscript = '';
				interimTranscript = '';
				consecutiveSilenceCount = 0;
				
				// Reset UI elements
				elements.messageText.textContent = '';
				elements.editableText.value = '';
				elements.resultBox.classList.add('hidden');
			}

			// Change recognition language
			function changeRecognitionLanguage(newLang) {
				currentLang = newLang;
				
				// Update recognition instance if it exists
				if (recognition) {
					const wasRecording = isRecording;
					
					// Stop current recognition
					if (wasRecording) {
						stopRecognition();
					}
					
					// Update language
					recognition.lang = currentLang;
					
					// Restart if it was active
					if (wasRecording) {
						// Short delay to ensure clean restart
						setTimeout(() => {
							startRecognition();
						}, 300);
					}
				}
			}

			// Event listener for mic button
			elements.micBtn.addEventListener('click', () => {
				// Clear autosave when starting new recording
				localStorage.removeItem('autosave');
				toggleRecognition();
			});

			// Event listener for tab switching (language change)
			elements.tabs.forEach(tab => {
				tab.addEventListener('click', () => {
					// Update UI
					elements.tabs.forEach(t => t.classList.remove('active'));
					tab.classList.add('active');
					
					// Get new language
					const newLang = tab.dataset.lang;
					
					// Update placeholders and UI text
					updateUILanguage(newLang);
					
					// Change recognition language
					changeRecognitionLanguage(newLang);
					
					// Show status
					const langNames = {
						'vi-VN': 'Tiếng Việt',
						'ja-JP': 'Tiếng Nhật',
						'en-US': 'Tiếng Anh'
					};
					showStatus('info', `Đã chuyển sang ${langNames[newLang] || newLang}`);
					
					// Retranslate current text if exists
					if (elements.editableText.value.trim()) {
						displayTranslation(elements.editableText.value.trim());
					}
				});
			});

			// Handle user typing directly into textarea
			elements.editableText.addEventListener('input', () => {
				// Update final transcript when user types
				finalTranscript = elements.editableText.value.trim();
				
				// Enable action buttons if text exists
				toggleActionButtons(!!finalTranscript);
				
				// Schedule translation
				scheduleTranslation(finalTranscript);
			});

			// Add support for keyboard shortcuts
			document.addEventListener('keydown', (event) => {
				// Space key to toggle recording (only when no input fields are focused)
				if (event.code === 'Space' && document.activeElement !== elements.editableText) {
					event.preventDefault();
					toggleRecognition();
				}
			});

			// Init on page load
			function initializeSpeechRecognition() {
				// Initialize speech recognition
				initSpeechRecognition();
				
				// Set initial status
				showStatus('ready', 'Nhấn nút microphone và nói...');
			}

			// Update UI text based on selected language
			function updateUILanguage(lang) {
				// Update textarea placeholder
				elements.editableText.placeholder = {
					'vi-VN': 'Tin nhắn của bạn sẽ xuất hiện ở đây...',
					'ja-JP': 'メッセージはここに表示されます...',
					'en-US': 'Your message will appear here...'
				}[lang] || 'Nhập tin nhắn...';
				
				// Update other UI elements as needed
				elements.suggestionsTitle.textContent = {
					'vi-VN': 'Có phải bạn muốn nói là:',
					'ja-JP': 'もしかして言いたかったのは：',
					'en-US': 'Did you mean:'
				}[lang] || 'Gợi ý:';
			}

			// Call initialization when page loads
			document.addEventListener('DOMContentLoaded', initializeSpeechRecognition);
    </script>
</body>
</html>
